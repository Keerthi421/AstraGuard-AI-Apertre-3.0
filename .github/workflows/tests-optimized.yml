name: Tests & Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # Lightweight linting job - no heavy ML deps
  # ============================================================================
  lint:
    name: Lint & Code Quality
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: |
          requirements.txt
          requirements-dev.txt
    
    - name: Install linting tools only
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install black==24.1.1 flake8==7.0.0 mypy==1.8.0 pylint==3.0.3
    
    - name: Run Black formatter check
      run: black --check --diff anomaly classifier memory_engine state_machine
      continue-on-error: true
    
    - name: Run Flake8 linter
      run: |
        flake8 anomaly classifier memory_engine state_machine \
          --max-line-length=100 --count --show-source --statistics
      continue-on-error: true
    
    - name: Run MyPy type checker
      run: |
        mypy anomaly classifier memory_engine state_machine \
          --ignore-missing-imports --warn-unused-ignores
      continue-on-error: true

  # ============================================================================
  # Security scanning job - minimal deps
  # ============================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: |
          requirements.txt
          requirements-dev.txt
    
    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit==1.7.5 safety==2.3.5
    
    - name: Run Bandit security scan
      run: bandit -r anomaly classifier state_machine memory_engine -ll
      continue-on-error: true
    
    - name: Install full requirements for dependency check
      run: |
        pip install -r requirements.txt
    
    - name: Check for known vulnerabilities
      run: safety check --json
      continue-on-error: true

  # ============================================================================
  # Unit tests job - single Python version, optimized deps
  # ============================================================================
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    services:
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: |
          requirements.txt
          requirements-dev.txt
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        # Install test requirements only (not all of requirements-dev.txt)
        pip install -r requirements.txt
        pip install pytest==8.3.2 pytest-cov==7.0.0 pytest-mock==3.15.1 \
                    pytest-timeout==2.1.0 pytest-asyncio==0.24.0
    
    - name: Wait for Redis
      run: |
        python -c "
        import redis
        import time
        import sys
        for i in range(30):
            try:
                r = redis.Redis(host='localhost', port=6379, socket_connect_timeout=5)
                r.ping()
                print('Redis is ready!')
                sys.exit(0)
            except Exception as e:
                print(f'Waiting for Redis... ({i+1}/30)')
                time.sleep(1)
        print('Redis connection timeout')
        sys.exit(1)
        "
    
    - name: Run pytest with coverage
      env:
        REDIS_URL: redis://localhost:6379
      run: |
        pytest tests/ \
          -v \
          --cov=anomaly \
          --cov=classifier \
          --cov=logs \
          --cov=memory_engine \
          --cov=state_machine \
          --cov-report=term-missing \
          --cov-report=html:coverage_html \
          --cov-report=xml \
          --timeout=10 \
          --tb=short
    
    - name: Check coverage threshold
      run: coverage report --fail-under=75
    
    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report-python311
        path: coverage_html/
        retention-days: 30
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      if: always()
      with:
        files: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
    
    - name: Clean up pip cache to save disk space
      if: always()
      run: |
        pip cache purge
        rm -rf ~/.cache/pip/*

  # ============================================================================
  # Multi-version matrix tests (optional, only on PRs and develop)
  # ============================================================================
  test-matrix:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: test
    if: |
      github.event_name == 'pull_request' || 
      github.ref == 'refs/heads/develop'
    strategy:
      matrix:
        python-version: ['3.9', '3.12']
      fail-fast: false
    services:
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
        cache-dependency-path: |
          requirements.txt
          requirements-dev.txt
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
        pip install pytest==8.3.2 pytest-cov==7.0.0 pytest-mock==3.15.1 \
                    pytest-timeout==2.1.0 pytest-asyncio==0.24.0
    
    - name: Wait for Redis
      run: |
        python -c "
        import redis, time, sys
        for i in range(30):
            try:
                r = redis.Redis(host='localhost', port=6379, socket_connect_timeout=5)
                r.ping()
                sys.exit(0)
            except:
                time.sleep(1)
        sys.exit(1)
        "
    
    - name: Run pytest
      env:
        REDIS_URL: redis://localhost:6379
      run: |
        pytest tests/ \
          -v \
          --cov=anomaly \
          --cov=classifier \
          --cov=logs \
          --cov=memory_engine \
          --cov=state_machine \
          --cov-report=xml \
          --timeout=10 \
          --tb=short
    
    - name: Clean up pip cache
      if: always()
      run: |
        pip cache purge
        rm -rf ~/.cache/pip/*
